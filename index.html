<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ScoreMaster AI - Stable</title>
    <style>
        :root { --p: #4f46e5; --s: #10b981; --bg: #f8fafc; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); padding: 15px; margin: 0; display: flex; justify-content: center; }
        .app { width: 100%; max-width: 450px; }
        .card { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 20px; }
        h2 { text-align: center; color: var(--p); margin-top: 0; }
        input, textarea { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #e2e8f0; border-radius: 10px; box-sizing: border-box; font-size: 16px; }
        .btn { width: 100%; padding: 14px; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; transition: 0.2s; margin-top: 5px; }
        .btn-ai { background: var(--s); color: white; }
        .btn-p { background: var(--p); color: white; }
        .btn-calc { background: #1e293b; color: white; margin-top: 15px; }
        .player-row { background: #f1f5f9; padding: 15px; border-radius: 12px; margin-top: 10px; }
        .field-input { display: flex; justify-content: space-between; align-items: center; margin-top: 8px; }
        #msg { text-align: center; font-size: 0.85rem; color: #64748b; margin-top: 10px; min-height: 20px; }
    </style>
</head>
<body>

<div class="app">
    <div class="card">
        <h2>üèÜ ScoreMaster</h2>
        <textarea id="rules" rows="2" placeholder="Nom du jeu ou r√®gle..."></textarea>
        <button class="btn btn-ai" onclick="fetchAI()">üß† Configurer par l'IA</button>
        <button class="btn" style="background:#e2e8f0; font-size: 0.7rem;" onclick="manualConfig()">‚öôÔ∏è Mode Manuel (Sans IA)</button>
        <div id="msg">Pr√™t √† jouer</div>
    </div>

    <div class="card">
        <div style="display:flex; gap:8px;">
            <input type="text" id="pName" placeholder="Nom du joueur">
            <button class="btn btn-p" style="width:60px; margin:8px 0;" onclick="addP()">+</button>
        </div>
        <div id="playerList"></div>
        <button class="btn btn-calc" onclick="calculate()">D√©signer le vainqueur üèÜ</button>
        <div id="winner" style="display:none; margin-top:15px; padding:15px; background:#dcfce7; border-radius:10px; text-align:center; font-weight:bold; color:#166534;"></div>
    </div>
</div>

<script>
    const API_KEY = "AIzaSyBz-hjRxMNXjheqJb3d4_awpvYZw06ozjY";
    let players = [];
    let fields = [{name: "Score", weight: 1}];
    let winMode = "high";

    async function fetchAI() {
        const text = document.getElementById('rules').value;
        const msg = document.getElementById('msg');
        if(!text) { msg.innerText = "Indiquez un nom de jeu"; return; }
        
        msg.innerText = "‚è≥ Connexion Google...";
        
        const prompt = `Jeu : ${text}. R√©ponds UNIQUEMENT en JSON : {"fields":[{"name":"Points","weight":1}],"mode":"high"}`;

        try {
            // Tentative directe avec le nom de mod√®le le plus standard possible
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${API_KEY}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
            });

            const data = await response.json();
            if(data.error) throw new Error(data.error.message);

            const raw = data.candidates[0].content.parts[0].text;
            const clean = JSON.parse(raw.match(/\{.*\}/s)[0]);
            
            fields = clean.fields;
            winMode = clean.mode || "high";
            msg.innerText = "‚úÖ IA Connect√©e !";
            render();
        } catch (e) {
            console.error(e);
            msg.innerText = "‚ö†Ô∏è IA indisponible (Mode manuel activ√©)";
            manualConfig();
        }
    }

    function manualConfig() {
        const name = prompt("Nom de la cat√©gorie (ex: Points, Plis, Trous) :", "Points");
        if(name) {
            fields = [{name: name, weight: 1}];
            winMode = confirm("Le score le plus HAUT gagne ? (OK = Oui, Annuler = Plus petit score gagne)") ? "high" : "low";
            document.getElementById('msg').innerText = "‚öôÔ∏è Configuration manuelle active";
            render();
        }
    }

    function addP() {
        const input = document.getElementById('pName');
        if(input.value) {
            players.push({ name: input.value, scores: {} });
            input.value = "";
            render();
        }
    }

    function render() {
        const list = document.getElementById('playerList');
        list.innerHTML = players.map((p, i) => `
            <div class="player-row">
                <strong>${p.name}</strong>
                ${fields.map(f => `
                    <div class="field-input">
                        <small>${f.name}</small>
                        <input type="number" value="${p.scores[f.name] || 0}" 
                            onchange="players[${i}].scores['${f.name}']=Number(this.value)" 
                            style="width:80px; margin:0; padding:5px;">
                    </div>
                `).join('')}
            </div>
        `).join('');
    }

    function calculate() {
        if(players.length === 0) return;
        players.forEach(p => {
            let t = 0;
            fields.forEach(f => t += (p.scores[f.name] || 0) * f.weight);
            p.total = t;
        });
        
        const winner = players.reduce((prev, curr) => 
            (winMode === "high" ? curr.total > prev.total : curr.total < prev.total) ? curr : prev
        );

        const winDiv = document.getElementById('winner');
        winDiv.style.display = "block";
        winDiv.innerHTML = `üéâ VICTOIRE DE ${winner.name.toUpperCase()} !<br>Score : ${winner.total} points`;
    }
</script>

</body>
</html>
